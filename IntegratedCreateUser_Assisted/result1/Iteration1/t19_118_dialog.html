//>>built
define("curam/dialog",["curam/util","curam/debug","curam/util/Refresh","curam/tab","curam/util/RuntimeContext","curam/define","curam/util/onLoad","cm/_base/_dom","curam/util/ResourceBundle"],function(_1,_2){
dojo.requireLocalization("curam.application","Debug");
var _3=new curam.util.ResourceBundle("Debug");
curam.define.singleton("curam.dialog",{MODAL_PREV_FLAG:"o3modalprev",MODAL_PREV_FLAG_INPUT:"curam_dialog_prev_marker",FORCE_CLOSE:false,ERROR_MESSAGES_HEADER:"error-messages-header",_hierarchy:[],_id:null,_displayedHandlerUnsToken:null,_displayed:false,_size:null,_justClose:false,validTargets:{"_top":true,"_self":true},initModal:function(_4,_5){
curam.dialog.pageId=_4;
curam.dialog.messagesExist=_5;
var _6=_1.getTopmostWindow();
var _7=false;
var _8=_6.dojo.subscribe("/curam/dialog/SetId",this,function(_9){
_2.log("curam.dialog: "+_3.getProperty("curam.dialog.id"),_9);
curam.dialog._id=_9;
_7=true;
_6.dojo.unsubscribe(_8);
});
_6.dojo.publish("/curam/dialog/init");
if(!_7){
_2.log("curam.dialog: "+_3.getProperty("curam.dialog.no.id"));
_6.dojo.unsubscribe(_8);
}
if(curam.dialog.closeDialog(false)){
return;
}
curam.dialog._displayedHandlerUnsToken=_1.getTopmostWindow().dojo.subscribe("/curam/dialog/displayed",null,function(_a,_b){
if(_a==curam.dialog._id){
curam.dialog._displayed=true;
curam.dialog._size=_b;
_1.getTopmostWindow().dojo.unsubscribe(curam.dialog._displayedHandlerUnsToken);
curam.dialog._displayedHandlerUnsToken=null;
}
});
if(jsScreenContext.hasContextBits("AGENDA")||jsScreenContext.hasContextBits("TREE")){
dojo.addOnUnload(function(){
_1.getTopmostWindow().dojo.unsubscribe(curam.dialog._displayedHandlerUnsToken);
curam.dialog._displayedHandlerUnsToken=null;
});
}
dojo.addOnLoad(function(){
_1.connect(dojo.body(),"onclick",curam.dialog.modalEventHandler);
for(var i=0;i<document.forms.length;i++){
var _c=document.forms[i];
curam.dialog.addFormInput(_c,"hidden","o3frame","modal");
var _d=dojo.byId("o3ctx");
var sc=new curam.util.ScreenContext(jsScreenContext.getValue());
sc.addContextBits("ACTION|ERROR");
_d.value=sc.getValue();
_1.connect(_c,"onsubmit",curam.dialog.formSubmitHandler);
}
window.curamModal=true;
});
dojo.addOnUnload(function(){
_1.getTopmostWindow().dojo.publish("/curam/dialog/iframeUnloaded",[curam.dialog._id,window]);
});
if(_7){
dojo.publish("/curam/dialog/ready");
}
},closeDialog:function(_e){
if(_e){
curam.dialog.forceClose();
}
var _f=curam.dialog.checkClose(curam.dialog.pageId);
if(_f){
_1.onLoad.addPublisher(function(_10){
_10.modalClosing=true;
});
if(curam.dialog.messagesExist){
dojo.addOnLoad(function(){
var _11=dojo.byId(_1.ERROR_MESSAGES_CONTAINER);
var _12=dojo.byId(_1.ERROR_MESSAGES_LIST);
var _13=dojo.byId(curam.dialog.ERROR_MESSAGES_HEADER);
if(_12&&_13){
_1.saveInformationalMsgs(_f);
_1.disableInformationalLoad();
}else{
_f();
}
});
}else{
_f();
}
return true;
}
return false;
},addFormInput:function(_14,_15,_16,_17){
return dojo.create("input",{"type":_15,"name":_16,"value":_17},_14);
},checkClose:function(_18){
if(curam.dialog._justClose){
return function(){
curam.dialog.closeModalDialog();
};
}
var _19=curam.dialog.getParentWindow(window);
if(!_19){
return false;
}
var _1a=window.location.href;
var _1b=curam.dialog.MODAL_PREV_FLAG;
var _1c=_1.getUrlParamValue(_1a,_1b);
var _1d=true;
if(_1c){
if(_19){
if(_1c==_18){
_1d=false;
}
}
}else{
_1d=false;
}
var _1e=_1.getUrlParamValue(_1a,"o3ctx");
if(_1e){
var sc=new curam.util.ScreenContext();
sc.setContext(_1e);
if(sc.hasContextBits("TREE|ACTION")){
_1d=false;
}
}
if(_1d||curam.dialog.FORCE_CLOSE){
if(!curam.dialog.FORCE_CLOSE){
if(_1c=="user-prefs-editor"){
return function(){
if(_19&&_19.location!==_1.getTopmostWindow().location){
curam.dialog.doRedirect(_19);
}
curam.dialog.closeModalDialog();
};
}
return function(){
var rp=_1.removeUrlParam;
_1a=rp(rp(rp(_1a,_1b),"o3frame"),_1.PREVENT_CACHE_FLAG);
_1a=_1.adjustTargetContext(_19,_1a);
if(_19&&_19.location!==_1.getTopmostWindow().location){
curam.dialog.doRedirect(_19,_1a,true);
}else{
curam.tab.getTabController().handleLinkClick(_1a);
}
curam.dialog.closeModalDialog();
};
}else{
return function(){
if(_19!==_1.getTopmostWindow()){
_19.curam.util.loadInformationalMsgs();
}
curam.dialog.closeModalDialog();
};
}
}
return false;
},getParentWindow:function(_1f){
if(!_1f){
_2.log("curam.dialog.getParentWindow(): "+_3.getProperty("curam.dialog.no.child"),window);
_2.log("returning as parent = ",window.parent.location.href);
return window.parent;
}
_2.log("curam.dialog.getParentWindow(): "+_3.getProperty("curam.dialog.child"),_1f.location.href);
var _20=curam.dialog._getDialogHierarchy();
for(var i=0;i<_20.length;i++){
if(_20[i]==_1f){
var _21=(i>0)?_20[i-1]:_20[0];
_2.log("curam.dialog.getParentWindow(): "+_3.getProperty("curam.dialog.parent.window"),_21);
return _21;
}
}
_2.log("curam.dialog.getParentWindow(): "+_3.getProperty("curam.dialog.child.not.found"),_1f.location.href);
_2.log("curam.dialog.getParentWindow(): "+_3.getProperty("curam.dialog.hierarchy"),_20);
var ret=_20.length>0?_20[_20.length-1]:undefined;
_2.log("curam.dialog.getParentWindow(): "+_3.getProperty("curam.dialog.returning.parent"),ret?ret.location.href:"undefined");
return ret;
},_getDialogHierarchy:function(){
var _22=_1.getTopmostWindow();
_22.require(["curam/dialog"]);
return _22.curam.dialog._hierarchy;
},pushOntoDialogHierarchy:function(_23){
var _24=curam.dialog._getDialogHierarchy();
if(dojo.indexOf(_24,_23)<0){
_24.push(_23);
_2.log(_3.getProperty("curam.dialog.add.hierarchy"),_23.location.href);
_2.log(_3.getProperty("curam.dialog.full.hierarchy"),_24);
}
},removeFromDialogHierarchy:function(_25){
var _26=curam.dialog._getDialogHierarchy();
if(!_25||_26[_26.length-1]==_25){
_26.pop();
}else{
_2.log("curam.dialog.removeFromDialogHierarchy(): "+_3.getProperty("curam.dialog.ignore.request"));
try{
_2.log(_25.location.href);
}
catch(e){
_2.log(e.message);
}
}
},stripPageOrActionFromUrl:function(url){
var idx=url.lastIndexOf("Page.do");
var len=7;
if(idx<0){
idx=url.lastIndexOf("Action.do");
len=9;
}
if(idx<0){
idx=url.lastIndexOf("Frame.do");
len=8;
}
if(idx>-1&&idx==url.length-len){
return url.substring(0,idx);
}
return url;
},_isSameBaseUrl:function(_27,rtc,_28){
if(_27&&_27.indexOf("#")==0){
return true;
}
var _29=_27.split("?");
var _2a=rtc.getHref().split("?");
if(_29[0].indexOf("/")<0){
var _2b=_2a[0].split("/");
_2a[0]=_2b[_2b.length-1];
}
if(_2a[0].indexOf("/")<0){
var _2b=_29[0].split("/");
_29[0]=_2b[_2b.length-1];
}
if(_28&&_28==true){
_29[0]=curam.dialog.stripPageOrActionFromUrl(_29[0]);
_2a[0]=curam.dialog.stripPageOrActionFromUrl(_2a[0]);
}
if(_29[0]==_2a[0]){
return true;
}
return false;
},modalEventHandler:function(_2c){
curam.dialog._doHandleModalEvent(_2c,new curam.util.RuntimeContext(window),curam.dialog.closeModalDialog,curam.dialog.doRedirect);
},_doHandleModalEvent:function(e,rtc,_2d,_2e){
var _2f=e.target;
var u=_1;
switch(_2f.tagName){
case "INPUT":
if(dojo.attr(_2f,"type")=="submit"&&typeof _2f.form!="undefined"){
_2f.form.setAttribute("keepModal",_2f.getAttribute("keepModal"));
}
return true;
case "IMG":
case "SPAN":
case "DIV":
_2f=cm.getParentByType(_2f,"A");
if(_2f==null){
return;
}
case "A":
if(_2f._submitButton){
_2f._submitButton.form.setAttribute("keepModal",_2f._submitButton.getAttribute("keepModal"));
return;
}
break;
default:
return true;
}
var _30=dojo.stopEvent;
var _31=_2f.getAttribute("href");
if(_31==""){
_2d();
return false;
}
if(_31.indexOf("javascript")==0){
return false;
}
var ctx=jsScreenContext;
ctx.addContextBits("MODAL");
if(!_31){
return false;
}
var _32=_2f.getAttribute("target");
if(_32&&!curam.dialog.validTargets[_32]){
return true;
}
if(_31&&_31.indexOf("/servlet/FileDownload?")>-1){
var _33=dojo.create("iframe",{src:_31},dojo.body());
_33.style.display="none";
_30(e);
return false;
}
if(dojo.hasClass(_2f,"external-link")){
return true;
}
if(_1.isSameUrl(_31,null,rtc)){
if(_31.indexOf("#")<0){
_31=u.replaceUrlParam(_31,"o3frame","modal");
_31=u.replaceUrlParam(_31,"o3ctx",ctx.getValue());
_2e(window,_31);
return false;
}
return true;
}
if(_31&&curam.dialog._isSameBaseUrl(_31,rtc,true)&&!_2f.getAttribute("keepModal")){
_2f.setAttribute("keepModal","true");
}
var _34=curam.dialog.getParentWindow(rtc.contextObject());
if(_2f&&_2f.getAttribute){
_30(e);
if(_2f.getAttribute("keepModal")=="true"){
_31=u.replaceUrlParam(_31,"o3frame","modal");
_31=u.replaceUrlParam(_31,"o3ctx",ctx.getValue());
_2e(window,_31);
}else{
if(_34){
_31=u.removeUrlParam(_31,"o3frame");
_31=u.removeUrlParam(_31,curam.dialog.MODAL_PREV_FLAG);
if(_34.location!==_1.getTopmostWindow().location){
var _35=new curam.util.RuntimeContext(_34);
var _36=_35.getHref();
_36=u.removeUrlParam(_36,"o3frame");
if(_1.isActionPage(_36)){
if(!curam.dialog._isSameBaseUrl(_31,_35,true)){
_31=u.adjustTargetContext(_34,_31);
_2e(_34,_31);
}
}else{
if(!_1.isSameUrl(_31,_36)){
_31=u.adjustTargetContext(_34,_31);
curam.dialog.doRedirect(_34,_31);
}
}
}else{
var _37=new curam.util.ScreenContext("TAB");
_31=u.replaceUrlParam(_31,"o3ctx",_37.getValue());
curam.tab.getTabController().handleLinkClick(_31);
}
_2d();
}
}
return false;
}
if(_34&&typeof (_2f)=="undefined"||_2f==null||_2f=="_self"||_2f==""){
_30(e);
_31=_31.replace(/[&?]o3frame=modal/g,"").replace("%3Fo3frame%3Dmodal","").replace("?o3frame%3Dmodal","");
_31=_1.updateCtx(_31);
if(_34.location!==_1.getTopmostWindow().location){
_2e(_34,_31);
}else{
var _37=new curam.util.ScreenContext("TAB");
_31=u.replaceUrlParam(_31,"o3ctx",_37.getValue());
curam.tab.getTabController().handleLinkClick(_31);
}
_2d();
return false;
}
return true;
},formSubmitHandler:function(e){
var _38=curam.dialog.getParentWindow(window);
if(typeof _38=="undefined"){
return true;
}
e.target.method="post";
e.target.setAttribute("target",window.name);
var _39=e.target.action;
var _3a=curam.dialog.MODAL_PREV_FLAG;
var _3b=curam.dialog.MODAL_PREV_FLAG_INPUT;
var u=_1;
var _3c=dojo.byId(_3b);
if(_3c){
_3c.parentNode.removeChild(_3c);
}
if(e.target.getAttribute("keepModal")!="true"&&!jsScreenContext.hasContextBits("AGENDA")){
var _3d="multipart/form-data";
if(e.target.enctype==_3d||e.target.encoding==_3d){
e.target.action=u.removeUrlParam(_39,_3a);
_3c=curam.dialog.addFormInput(e.target,"hidden",_3a,curam.dialog.pageId);
_3c.setAttribute("id",_3b);
_3c.id=_3b;
}else{
e.target.action=u.replaceUrlParam(_39,_3a,curam.dialog.pageId);
}
}else{
e.target.action=u.removeUrlParam(_39,_3a);
}
_38.curam.util.invalidatePage();
if(!jsScreenContext.hasContextBits("EXTAPP")){
_1.firePageSubmittedEvent("dialog");
}
return true;
},forceClose:function(){
curam.dialog.FORCE_CLOSE=true;
},forceParentRefresh:function(){
var _3e=curam.dialog.getParentWindow(window);
if(!_3e){
return;
}
_3e.curam.util.FORCE_REFRESH=true;
},closeModalDialog:function(){
var _3f=_1.getTopmostWindow();
if(curam.dialog._displayedHandlerUnsToken!=null){
_3f.dojo.unsubscribe(curam.dialog._displayedHandlerUnsToken);
curam.dialog._displayedHandlerUnsToken=null;
}
if(typeof (curam.dialog._id)=="undefined"||curam.dialog._id==null){
var _40=window.frameElement.id;
var _41=_40.substring(7);
curam.dialog._id=_41;
_2.log("curam.dialog.closeModalDialog() "+_3.getProperty("curam.dialog.modal.id")+_41);
}
_2.log("publishing /curam/dialog/close for ",curam.dialog._id);
_1.getTopmostWindow().dojo.publish("/curam/dialog/close",[curam.dialog._id]);
_2.log("publishing /curam/dialog/close for ",curam.dialog._id);
},parseWindowOptions:function(_42){
var _43={};
if(_42){
_2.log("curam.dialog.parseWindowOptions "+_3.getProperty("curam.dialog.parsing"),_42);
var _44=_42.split(",");
var _45;
for(var i=0;i<_44.length;i++){
_45=_44[i].split("=");
_43[_45[0]]=_45[1];
}
_2.log("done:",dojo.toJson(_43));
}else{
_2.log("curam.dialog.parseWindowOptions "+_3.getProperty("curam.dialog.no.options"));
}
return _43;
},doRedirect:function(_46,_47,_48,_49){
window.curamDialogRedirecting=true;
_46.curam.util.redirectWindow(_47,_48,_49);
},closeGracefully:function(){
curam.dialog._justClose=true;
}});
return curam.dialog;
});
