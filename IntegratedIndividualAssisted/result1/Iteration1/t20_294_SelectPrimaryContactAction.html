/*
 * Licensed Materials - Property of IBM
 * 
 * Copyright IBM Corporation 2012 - 2014. All Rights Reserved.
 *
 * US Government Users Restricted Rights - Use, duplication or disclosure 
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 */

hcr.eventHandler.registerAction(SelectPrimaryContactAction={

	eventType : 'select_primary_contact',
	
	execute : function(args) {
	
		SelectPrimaryContactAction.selectPrimaryContact(args);
		
	},
	
	selectPrimaryContact: function(args) {
	
			var primaryContact = [];
			hcr.blockAndShowErrorMessage = false;
	    
	    dojo.query('input:checked', 'select-members-pane').forEach(
	        function(checkbox) {
                primaryContact.push(checkbox.value);
	        }
	    );
	    
	    var motivationID = getMotivationID();  
	    
			if (primaryContact.length == 0) {
				hcr.blockAndShowErrorMessage = true;
				SelectPrimaryContactAction.createErrorMessage("One person must be selected as the primary client");

			} else if (primaryContact.length > 1) {
				hcr.blockAndShowErrorMessage = true;
				SelectPrimaryContactAction.createErrorMessage("Only one person must be selected as the primary client");
			
			} else {
				var saveUrl = cw.fragment.constructURL('HealthCare_actionSaveEnrollment');
				var saveParams = {
				    motivationID:args.motivationID, 
				    members:args.members, 
				    programID:args.programID, 
				    primaryContact:primaryContact
				};
				cw.ajax.call(saveUrl, saveParams,
	                SelectPrimaryContactAction.selectPrimaryContactCallback);
			}
	        
	},
	selectPrimaryContactCallback: function(message, call) {
	
		var enrollmentObj = message.getElementsByTagName("enrollmentID")[0];    
		var enrollmentID = dojox.xml.parser.textContent(enrollmentObj);
		var programID = call.args.content.programID;
		var members = call.args.content.members;
		var reenrollingObj = message.getElementsByTagName("reenrolling")[0];
		var reenrolling = dojox.xml.parser.textContent(reenrollingObj);
		cw.event.dispatchEvent('open_connecture', {
		    enrollmentID:enrollmentID, 
		    programID:programID, 
		    members:members,
		    reenrolling: reenrolling
		});
	},
	
	createErrorMessage: function(msg) {
		dojo.query('#error-messages-container').forEach(dojo.destroy);
		
		var contentPane = dojo.byId("select-members-pane");
				
		var hcrErrorMessages = dojo.create("div", 
				{id: "error-messages-container"}, contentPane, "first");
      
    dojo.query('#error-messages-container').forEach(function(node) { node.innerHTML = 
      "<div><img src=\"./Images/error_icon.png\">"+msg+"</div>"; });
      
	}

});

