/*
 * Licensed Materials - Property of IBM
 * 
 * Copyright IBM Corporation 2012 - 2013. All Rights Reserved.
 *
 * US Government Users Restricted Rights - Use, duplication or disclosure 
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 */
hcr.eventHandler.registerAction(SelectMembersAction={

	eventType : 'select_members',
	
	execute : function(args) {
	
		SelectMembersAction.selectMembers(args.programID, args.url);
		
	},
	
	selectMembers: function(programID, url) {
	
	    var members = [];
	    hcr.blockAndShowErrorMessage = false;
	    
	    dojo.query('input:checked', 'select-members-pane').forEach(
	        function(checkbox) {
                members.push(checkbox.value);
	        }
	    );
	    
	    var motivationID = getMotivationID();
	    
	     if (members.length == 0) {
	      hcr.blockAndShowErrorMessage = true;
				SelectMembersAction.createErrorMessage("At least one person must be selected to proceed with the enrollment");
			} else if (members.length > 1 && programID.indexOf("ESCELIGIBLE") === -1) {
        
				cw.fragment.load(
					'background-panel', 
					'HealthCare_actionSelectPrimaryContact', 
					{motivationID:motivationID, programID:programID, members: members});
        
	    } else {
	    	primaryContact = members[0];
	    	var saveUrl = cw.fragment.constructURL('HealthCare_actionSaveEnrollment');
	    	var saveParams = {
	    	    motivationID:motivationID, 
	    	    members:members.join(), 
	    	    programID:programID, 
	    	    primaryContact:primaryContact
	    	};
	    	cw.ajax.call(saveUrl, saveParams,
	            SelectMembersAction.selectMembersCallback);
	    }  
	},
	
	selectMembersCallback: function(message, call) { 
		var enrollmentObj = message.getElementsByTagName("enrollmentID")[0];    
		var enrollmentID = dojox.xml.parser.textContent(enrollmentObj);
		var programID = call.args.content.programID;
		var members = call.args.content.members;
		var reenrollingObj = message.getElementsByTagName("reenrolling")[0];
		var reenrolling = dojox.xml.parser.textContent(reenrollingObj);
		cw.event.dispatchEvent('open_connecture', {
		    enrollmentID:enrollmentID, 
		    programID:programID, 
		    members:members,
		    reenrolling: reenrolling
		});
	
	},
	
	createErrorMessage: function(msg) {
		dojo.query('#error-messages-container').forEach(dojo.destroy);
		
		var contentPane = dojo.byId("select-members-pane");
				
		var hcrErrorMessages = dojo.create("div", 
				{id: "error-messages-container"}, contentPane, "first");
      
    dojo.query('#error-messages-container').forEach(function(node) { node.innerHTML = 
      "<div><img src=\"./Images/error_icon.png\">"+msg+"</div>"; });
      
	}

});

