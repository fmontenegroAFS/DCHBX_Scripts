/*
 * Licensed Materials - Property of IBM
 * 
 * Copyright IBM Corporation 2014. All Rights Reserved.
 *
 * US Government Users Restricted Rights - Use, duplication or disclosure 
 * restricted by GSA ADP Schedule Contract with IBM Corp.
 */
hcr.eventHandler.registerAction(UpdateEntitlementAction={

	eventType : 'update_entitlement',
	
	execute : function(args) {
	
		UpdateEntitlementAction.updateEntitlement(args);
		
	},
	
	updateEntitlement: function(args) {
	
			var enrollments = [];
			var members = [];
			hcr.blockAndShowErrorMessage = false;
	    
	    dojo.query('input:checked', 'list-enrollments-table').forEach(
	        function(checkbox) {
                enrollments.push(checkbox.value);
	        }
	    );
	    
	    if (enrollments.length == 0) {
	    
				hcr.blockAndShowErrorMessage = true;
				UpdateEntitlementAction.createErrorMessage("At least one enrollment must be selected to proceed");
				
			} else if (enrollments.length > 1) {
			
	    	hcr.blockAndShowErrorMessage = true;
	    	UpdateEntitlementAction.createErrorMessage("Only one enrollment must be selected");
	    	
	    } else {
	    
	    	var checkBoxID = "checkbox" + enrollments;
	    	var members = dojo.attr(dojo.byId(checkBoxID), "members");
	    	
	    	var updateUrl = cw.fragment._constructPath('HealthCare_updateEntitlement');
	    	var updateParams = {
	    	    motivationID:args.motivationID, 
	    	    members:members,
	    	    programID:args.programID, 
	    	    enrollmentID:enrollments
	    	};
	    	cw.ajax.call(updateUrl, updateParams, 
	    	    UpdateEntitlementAction.updateEntitlementCallback);
	    }  
	},

	updateEntitlementCallback: function(message, call) {
		var content = call.args.content;
		cw.event.dispatchEvent('finish_enrollment', content);
	},
	
	createErrorMessage: function(msg) {
		dojo.query('#error-messages-container').forEach(dojo.destroy);
		
		var contentPane = dojo.byId("update-entitlement-pane");
				
		var hcrErrorMessages = dojo.create("div", 
				{id: "error-messages-container"}, contentPane, "first");
      
    dojo.query('#error-messages-container').forEach(function(node) { node.innerHTML = 
      "<div><img src=\"./Images/error_icon.png\">"+msg+"</div>"; });
      
	}
});